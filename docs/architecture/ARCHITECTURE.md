# DMN Engine Go — Архитектурная документация

## Оглавление

1. [Обзор системы](#1-обзор-системы)
2. [Диаграмма компонентов](#2-диаграмма-компонентов)
3. [Диаграмма классов (Domain Model)](#3-диаграмма-классов-domain-model)
4. [Диаграмма БД (ER-диаграмма)](#4-диаграмма-бд-er-диаграмма)
5. [Диаграмма развёртывания](#5-диаграмма-развёртывания)
6. [Диаграмма последовательности](#6-диаграмма-последовательности)
7. [C4 Model](#7-c4-model)

---

## 1. Обзор системы

### 1.1 Назначение

**DMN Engine Go** — высокопроизводительный движок выполнения бизнес-решений, реализующий стандарт DMN 1.3 (Decision Model and Notation) от OMG.

### 1.2 Ключевые характеристики

| Характеристика | Значение |
|----------------|----------|
| Язык | Go 1.22+ |
| Стандарт | DMN 1.3, FEEL 1.3 |
| Архитектура | Микросервисная |
| API | REST (OpenAPI 3.0) |
| Хранилище | PostgreSQL 16+ |
| Кэш | Redis 7+ |
| Контейнеризация | Docker, Kubernetes |

### 1.3 Контекст системы (C4 Level 1)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              SYSTEM CONTEXT                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│    ┌──────────────┐         ┌──────────────┐         ┌──────────────────┐      │
│    │   Business   │         │   Backend    │         │   DevOps /       │      │
│    │   Analyst    │         │   Services   │         │   Admin          │      │
│    │              │         │              │         │                  │      │
│    └──────┬───────┘         └──────┬───────┘         └────────┬─────────┘      │
│           │                        │                          │                │
│           │ Deploy DMN             │ Evaluate                 │ Monitor        │
│           │ Models                 │ Decisions                │ Configure      │
│           ▼                        ▼                          ▼                │
│    ┌─────────────────────────────────────────────────────────────────────┐     │
│    │                                                                     │     │
│    │                        DMN ENGINE GO                                │     │
│    │                                                                     │     │
│    │   High-Performance Decision Engine for Business Rules Execution    │     │
│    │                                                                     │     │
│    └─────────────────────────────────────────────────────────────────────┘     │
│                    │                    │                    │                 │
│                    ▼                    ▼                    ▼                 │
│           ┌──────────────┐     ┌──────────────┐     ┌──────────────┐          │
│           │  PostgreSQL  │     │    Redis     │     │ FEEL Engine  │          │
│           │   Database   │     │    Cache     │     │  (External)  │          │
│           └──────────────┘     └──────────────┘     └──────────────┘          │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Диаграмма компонентов

### 2.1 Component Diagram (UML)

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                 DMN ENGINE GO                                           │
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              API LAYER                                          │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                 │   │
│  │  │   REST API      │  │   Middleware    │  │   OpenAPI       │                 │   │
│  │  │   Controller    │  │   (Auth, Log,   │  │   Spec          │                 │   │
│  │  │                 │  │    Metrics)     │  │   Generator     │                 │   │
│  │  │  ┌───────────┐  │  │                 │  │                 │                 │   │
│  │  │  │ /deploy   │  │  │  ┌───────────┐  │  │                 │                 │   │
│  │  │  │ /evaluate │  │  │  │ RequestID │  │  │                 │                 │   │
│  │  │  │ /batch    │  │  │  │ Logger    │  │  │                 │                 │   │
│  │  │  │ /history  │  │  │  │ Tenant    │  │  │                 │                 │   │
│  │  │  └───────────┘  │  │  │ RateLimit │  │  │                 │                 │   │
│  │  │                 │  │  └───────────┘  │  │                 │                 │   │
│  │  └────────┬────────┘  └────────┬────────┘  └─────────────────┘                 │   │
│  └───────────┼────────────────────┼────────────────────────────────────────────────┘   │
│              │                    │                                                     │
│              ▼                    ▼                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │                            CORE LAYER                                           │   │
│  │                                                                                 │   │
│  │  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐     │   │
│  │  │   Definition        │  │   Evaluation        │  │   History           │     │   │
│  │  │   Service           │  │   Engine            │  │   Service           │     │   │
│  │  │                     │  │                     │  │                     │     │   │
│  │  │  • Deploy           │  │  • Evaluate         │  │  • Record           │     │   │
│  │  │  • GetByKey         │  │  • EvaluateBatch    │  │  • Query            │     │   │
│  │  │  • List             │  │  • BuildDRG         │  │  • Aggregate        │     │   │
│  │  │  • Delete           │  │  • ApplyHitPolicy   │  │  • Export           │     │   │
│  │  │  • Validate         │  │                     │  │                     │     │   │
│  │  └──────────┬──────────┘  └──────────┬──────────┘  └──────────┬──────────┘     │   │
│  │             │                        │                        │                │   │
│  │             │              ┌─────────┴─────────┐              │                │   │
│  │             │              │                   │              │                │   │
│  │             │              ▼                   ▼              │                │   │
│  │             │    ┌─────────────────┐ ┌─────────────────┐     │                │   │
│  │             │    │   Hit Policy    │ │   DRG           │     │                │   │
│  │             │    │   Engine        │ │   Resolver      │     │                │   │
│  │             │    │                 │ │                 │     │                │   │
│  │             │    │  • Unique       │ │  • TopSort      │     │                │   │
│  │             │    │  • First        │ │  • CycleDetect  │     │                │   │
│  │             │    │  • Collect      │ │  • Optimize     │     │                │   │
│  │             │    │  • Priority     │ │                 │     │                │   │
│  │             │    │  • Any          │ │                 │     │                │   │
│  │             │    └─────────────────┘ └─────────────────┘     │                │   │
│  │             │                                                 │                │   │
│  └─────────────┼─────────────────────────────────────────────────┼────────────────┘   │
│                │                                                 │                     │
│                ▼                                                 ▼                     │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │                          DOMAIN LAYER                                           │   │
│  │                                                                                 │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                 │   │
│  │  │   DMN Parser    │  │   DMN Model     │  │   DMN Validator │                 │   │
│  │  │                 │  │                 │  │                 │                 │   │
│  │  │  • ParseXML     │  │  • Definitions  │  │  • ValidateIDs  │                 │   │
│  │  │  • ParseFile    │  │  • Decision     │  │  • ValidateDRG  │                 │   │
│  │  │  • ParseBytes   │  │  • DecisionTab  │  │  • ValidateRules│                 │   │
│  │  │                 │  │  • Rule         │  │  • CheckCycles  │                 │   │
│  │  │                 │  │  • Input/Output │  │                 │                 │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘                 │   │
│  │                                                                                 │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                          │                                             │
│                                          ▼                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │                        INFRASTRUCTURE LAYER                                     │   │
│  │                                                                                 │   │
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐    │   │
│  │  │  FEEL Client  │  │  PostgreSQL   │  │  Redis Cache  │  │  Observability│    │   │
│  │  │               │  │  Repository   │  │               │  │               │    │   │
│  │  │ • Evaluate    │  │               │  │ • GetDef      │  │ • Metrics     │    │   │
│  │  │ • UnaryTest   │  │ • Deploy      │  │ • SetDef      │  │ • Tracing     │    │   │
│  │  │ • Batch       │  │ • GetByKey    │  │ • GetResult   │  │ • Logging     │    │   │
│  │  │ • Health      │  │ • List        │  │ • Invalidate  │  │               │    │   │
│  │  │               │  │ • Delete      │  │               │  │               │    │   │
│  │  └───────┬───────┘  └───────┬───────┘  └───────┬───────┘  └───────────────┘    │   │
│  │          │                  │                  │                               │   │
│  └──────────┼──────────────────┼──────────────────┼───────────────────────────────┘   │
│             │                  │                  │                                    │
└─────────────┼──────────────────┼──────────────────┼────────────────────────────────────┘
              │                  │                  │
              ▼                  ▼                  ▼
     ┌────────────────┐ ┌────────────────┐ ┌────────────────┐
     │  FEEL Engine   │ │   PostgreSQL   │ │     Redis      │
     │  (External)    │ │                │ │                │
     └────────────────┘ └────────────────┘ └────────────────┘
```

### 2.2 Компоненты и их ответственность

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         COMPONENT RESPONSIBILITIES                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  «component»                    «component»                                 │
│  ┌─────────────────────┐       ┌─────────────────────┐                     │
│  │   REST API          │       │   Definition        │                     │
│  │   Controller        │       │   Service           │                     │
│  ├─────────────────────┤       ├─────────────────────┤                     │
│  │ Responsibilities:   │       │ Responsibilities:   │                     │
│  │ • HTTP routing      │──────▶│ • DMN deployment    │                     │
│  │ • Request parsing   │       │ • Version control   │                     │
│  │ • Response format   │       │ • Validation        │                     │
│  │ • Error handling    │       │ • Caching strategy  │                     │
│  └─────────────────────┘       └──────────┬──────────┘                     │
│                                           │                                 │
│                                           ▼                                 │
│  «component»                    «component»                                 │
│  ┌─────────────────────┐       ┌─────────────────────┐                     │
│  │   Evaluation        │       │   DMN Parser        │                     │
│  │   Engine            │       │                     │                     │
│  ├─────────────────────┤       ├─────────────────────┤                     │
│  │ Responsibilities:   │       │ Responsibilities:   │                     │
│  │ • Decision eval     │──────▶│ • XML parsing       │                     │
│  │ • DRG traversal     │       │ • Model creation    │                     │
│  │ • Hit policy apply  │       │ • Schema validation │                     │
│  │ • FEEL integration  │       │                     │                     │
│  └─────────────────────┘       └─────────────────────┘                     │
│           │                                                                 │
│           ▼                                                                 │
│  «component»                    «component»                                 │
│  ┌─────────────────────┐       ┌─────────────────────┐                     │
│  │   FEEL Client       │       │   Repository        │                     │
│  │                     │       │                     │                     │
│  ├─────────────────────┤       ├─────────────────────┤                     │
│  │ Responsibilities:   │       │ Responsibilities:   │                     │
│  │ • Expression eval   │       │ • CRUD operations   │                     │
│  │ • Unary test eval   │       │ • Transaction mgmt  │                     │
│  │ • Connection pool   │       │ • Query optimization│                     │
│  │ • Circuit breaker   │       │                     │                     │
│  └─────────────────────┘       └─────────────────────┘                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Диаграмма классов (Domain Model)

### 3.1 DMN Domain Model

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                   DMN DOMAIN MODEL                                          │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                                  «aggregate root»                                    │   │
│  │                                   Definitions                                        │   │
│  │  ┌───────────────────────────────────────────────────────────────────────────────┐  │   │
│  │  │  - id: string                                                                 │  │   │
│  │  │  - name: string                                                               │  │   │
│  │  │  - namespace: string                                                          │  │   │
│  │  │  - expressionLanguage: string                                                 │  │   │
│  │  │  - decisions: []Decision                                                      │  │   │
│  │  │  - inputData: []InputData                                                     │  │   │
│  │  │  - businessKnowledgeModels: []BKM                                             │  │   │
│  │  ├───────────────────────────────────────────────────────────────────────────────┤  │   │
│  │  │  + GetDecision(id: string): *Decision                                         │  │   │
│  │  │  + GetInputData(id: string): *InputData                                       │  │   │
│  │  │  + Validate(): []ValidationError                                              │  │   │
│  │  └───────────────────────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                          │ 1                                                               │
│                          │                                                                 │
│                          │ *                                                               │
│                          ▼                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                                    «entity»                                         │   │
│  │                                    Decision                                         │   │
│  │  ┌───────────────────────────────────────────────────────────────────────────────┐  │   │
│  │  │  - id: string                                                                 │  │   │
│  │  │  - name: string                                                               │  │   │
│  │  │  - variable: *Variable                                                        │  │   │
│  │  │  - informationRequirements: []InformationRequirement                          │  │   │
│  │  │  - decisionTable: *DecisionTable                                              │  │   │
│  │  │  - literalExpression: *LiteralExpression                                      │  │   │
│  │  ├───────────────────────────────────────────────────────────────────────────────┤  │   │
│  │  │  + GetDependencies(): []string                                                │  │   │
│  │  │  + HasDecisionTable(): bool                                                   │  │   │
│  │  │  + HasLiteralExpression(): bool                                               │  │   │
│  │  └───────────────────────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────────────────────┘   │
│           │ 1                              │ 1                                             │
│           │                                │                                               │
│           │ 0..1                           │ 0..1                                          │
│           ▼                                ▼                                               │
│  ┌────────────────────────┐    ┌────────────────────────────────────────────────────┐     │
│  │    «value object»      │    │                    «entity»                        │     │
│  │  LiteralExpression     │    │                  DecisionTable                     │     │
│  │  ┌──────────────────┐  │    │  ┌────────────────────────────────────────────┐   │     │
│  │  │ - id: string     │  │    │  │  - id: string                              │   │     │
│  │  │ - typeRef: string│  │    │  │  - hitPolicy: HitPolicy                    │   │     │
│  │  │ - text: string   │  │    │  │  - aggregation: Aggregation                │   │     │
│  │  └──────────────────┘  │    │  │  - inputs: []Input                         │   │     │
│  └────────────────────────┘    │  │  - outputs: []Output                       │   │     │
│                                │  │  - rules: []Rule                           │   │     │
│                                │  ├────────────────────────────────────────────┤   │     │
│                                │  │  + GetInputCount(): int                    │   │     │
│                                │  │  + GetOutputCount(): int                   │   │     │
│                                │  │  + GetRuleCount(): int                     │   │     │
│                                │  └────────────────────────────────────────────┘   │     │
│                                └────────────────────────────────────────────────────┘     │
│                                          │ 1                                              │
│                                          │                                                │
│                                          │ *                                              │
│                                          ▼                                                │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                                  «entity»                                           │  │
│  │                                    Rule                                             │  │
│  │  ┌───────────────────────────────────────────────────────────────────────────────┐  │  │
│  │  │  - id: string                                                                 │  │  │
│  │  │  - description: string                                                        │  │  │
│  │  │  - inputEntries: []InputEntry                                                 │  │  │
│  │  │  - outputEntries: []OutputEntry                                               │  │  │
│  │  ├───────────────────────────────────────────────────────────────────────────────┤  │  │
│  │  │  + Matches(inputs: map[string]interface{}, evaluator: FEELEvaluator): bool    │  │  │
│  │  │  + GetOutputs(evaluator: FEELEvaluator): map[string]interface{}               │  │  │
│  │  └───────────────────────────────────────────────────────────────────────────────┘  │  │
│  └─────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                           │
│  ┌────────────────────────┐  ┌────────────────────────┐  ┌────────────────────────────┐  │
│  │   «value object»       │  │    «value object»      │  │      «value object»        │  │
│  │      Input             │  │      Output            │  │  InformationRequirement    │  │
│  │ ┌────────────────────┐ │  │ ┌────────────────────┐ │  │ ┌────────────────────────┐ │  │
│  │ │ - id: string       │ │  │ │ - id: string       │ │  │ │ - requiredDecision:    │ │  │
│  │ │ - label: string    │ │  │ │ - label: string    │ │  │ │   *RequiredDecision    │ │  │
│  │ │ - inputExpression: │ │  │ │ - name: string     │ │  │ │ - requiredInput:       │ │  │
│  │ │   InputExpression  │ │  │ │ - typeRef: string  │ │  │ │   *RequiredInput       │ │  │
│  │ └────────────────────┘ │  │ └────────────────────┘ │  │ └────────────────────────┘ │  │
│  └────────────────────────┘  └────────────────────────┘  └────────────────────────────┘  │
│                                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              «enumeration»                                          │  │
│  │                               HitPolicy                                             │  │
│  │  ┌───────────────────────────────────────────────────────────────────────────────┐  │  │
│  │  │  UNIQUE | FIRST | PRIORITY | ANY | COLLECT | RULE_ORDER | OUTPUT_ORDER        │  │  │
│  │  └───────────────────────────────────────────────────────────────────────────────┘  │  │
│  └─────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                           │
└───────────────────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Engine Domain Model

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                ENGINE DOMAIN MODEL                                          │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                               «service»                                            │    │
│  │                          EvaluationEngine                                          │    │
│  │ ┌────────────────────────────────────────────────────────────────────────────────┐ │    │
│  │ │  - feelClient: FEELClient                                                      │ │    │
│  │ │  - repository: DefinitionRepository                                            │ │    │
│  │ │  - cache: Cache                                                                │ │    │
│  │ │  - hitPolicies: map[HitPolicy]HitPolicyStrategy                                │ │    │
│  │ ├────────────────────────────────────────────────────────────────────────────────┤ │    │
│  │ │  + Evaluate(ctx, req: EvaluateRequest): (*EvaluateResult, error)               │ │    │
│  │ │  + EvaluateBatch(ctx, reqs: []EvaluateRequest): ([]EvaluateResult, error)      │ │    │
│  │ │  - evaluateDecision(ctx, decision, variables): ([]Output, error)               │ │    │
│  │ │  - evaluateRule(ctx, rule, inputs, variables): (bool, Output, error)           │ │    │
│  │ │  - buildExecutionOrder(defs, targetID): ([]string, error)                      │ │    │
│  │ └────────────────────────────────────────────────────────────────────────────────┘ │    │
│  └────────────────────────────────────────────────────────────────────────────────────┘    │
│                          │                                    │                            │
│                          │ uses                               │ uses                       │
│                          ▼                                    ▼                            │
│  ┌────────────────────────────────────┐    ┌────────────────────────────────────────────┐ │
│  │          «interface»               │    │              «interface»                   │ │
│  │          FEELClient                │    │          HitPolicyStrategy                 │ │
│  │ ┌────────────────────────────────┐ │    │ ┌────────────────────────────────────────┐ │ │
│  │ │ + Evaluate(ctx, req):          │ │    │ │ + Apply(matched: []MatchedRule,        │ │ │
│  │ │   (*EvaluateResponse, error)   │ │    │ │   aggregation: string):                │ │ │
│  │ │ + EvaluateUnaryTest(ctx, req): │ │    │ │   ([]map[string]interface{}, error)    │ │ │
│  │ │   (bool, error)                │ │    │ │ + ShouldStopOnFirstMatch(): bool       │ │ │
│  │ │ + Health(ctx): error           │ │    │ └────────────────────────────────────────┘ │ │
│  │ │ + Close(): error               │ │    └────────────────────────────────────────────┘ │
│  │ └────────────────────────────────┘ │                        △                          │
│  └────────────────────────────────────┘                        │                          │
│                   △                         ┌──────────────────┼──────────────────┐       │
│                   │                         │                  │                  │       │
│      ┌────────────┴────────────┐           ▼                  ▼                  ▼       │
│      │                         │   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐│
│      ▼                         ▼   │UniquePolicy  │   │ FirstPolicy  │   │CollectPolicy ││
│ ┌──────────────┐        ┌──────────────┐           │   │              │   │              ││
│ │ HTTPClient   │        │ MockClient   │└──────────────┘└──────────────┘   │ + aggregation││
│ │              │        │              │                                   └──────────────┘│
│ │- baseURL     │        │- responses   │                                                  │
│ │- httpClient  │        │              │                                                  │
│ └──────────────┘        └──────────────┘                                                  │
│                                                                                           │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              «value object»                                        │  │
│  │                             EvaluateRequest                                        │  │
│  │ ┌────────────────────────────────────────────────────────────────────────────────┐ │  │
│  │ │  - decisionKey: string                                                         │ │  │
│  │ │  - version: *int                                                               │ │  │
│  │ │  - variables: map[string]interface{}                                           │ │  │
│  │ │  - tenantID: string                                                            │ │  │
│  │ └────────────────────────────────────────────────────────────────────────────────┘ │  │
│  └────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                           │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              «value object»                                        │  │
│  │                             EvaluateResult                                         │  │
│  │ ┌────────────────────────────────────────────────────────────────────────────────┐ │  │
│  │ │  - decisionKey: string                                                         │ │  │
│  │ │  - decisionName: string                                                        │ │  │
│  │ │  - outputs: []map[string]interface{}                                           │ │  │
│  │ │  - matchedRules: []string                                                      │ │  │
│  │ │  - evaluatedAt: time.Time                                                      │ │  │
│  │ │  - durationNs: int64                                                           │ │  │
│  │ └────────────────────────────────────────────────────────────────────────────────┘ │  │
│  └────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                           │
└───────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Диаграмма БД (ER-диаграмма)

### 4.1 Entity-Relationship Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                              DATABASE ER DIAGRAM                                            │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐  │
│   │                              dmn_definitions                                        │  │
│   │  ┌───────────────────────────────────────────────────────────────────────────────┐  │  │
│   │  │  «PK» id              UUID           NOT NULL  DEFAULT gen_random_uuid()      │  │  │
│   │  │       key             VARCHAR(255)   NOT NULL                                 │  │  │
│   │  │       version         INT            NOT NULL  DEFAULT 1                      │  │  │
│   │  │       name            VARCHAR(255)                                            │  │  │
│   │  │       source          TEXT           NOT NULL  -- Original DMN XML            │  │  │
│   │  │       parsed_model    JSONB                    -- Pre-parsed AST              │  │  │
│   │  │       checksum        VARCHAR(64)              -- SHA256 of source            │  │  │
│   │  │       tenant_id       VARCHAR(64)                                             │  │  │
│   │  │       created_at      TIMESTAMPTZ    NOT NULL  DEFAULT NOW()                  │  │  │
│   │  │       created_by      VARCHAR(255)                                            │  │  │
│   │  │       description     TEXT                                                    │  │  │
│   │  ├───────────────────────────────────────────────────────────────────────────────┤  │  │
│   │  │  «UK» (key, version, tenant_id)                                               │  │  │
│   │  │  «IX» idx_def_key ON (key)                                                    │  │  │
│   │  │  «IX» idx_def_tenant ON (tenant_id) WHERE tenant_id IS NOT NULL               │  │  │
│   │  │  «IX» idx_def_key_version ON (key, version DESC)                              │  │  │
│   │  │  «IX» idx_def_created ON (created_at DESC)                                    │  │  │
│   │  └───────────────────────────────────────────────────────────────────────────────┘  │  │
│   └─────────────────────────────────────────────────────────────────────────────────────┘  │
│                                              │                                             │
│                                              │ 1                                           │
│                                              │                                             │
│                                              │                                             │
│                                              │ *                                           │
│                                              ▼                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐  │
│   │                           dmn_evaluation_history                                    │  │
│   │  ┌───────────────────────────────────────────────────────────────────────────────┐  │  │
│   │  │  «PK» id              UUID           NOT NULL  DEFAULT gen_random_uuid()      │  │  │
│   │  │  «FK» definition_id   UUID           REFERENCES dmn_definitions(id)           │  │  │
│   │  │       definition_key  VARCHAR(255)   NOT NULL                                 │  │  │
│   │  │       definition_ver  INT                                                     │  │  │
│   │  │       inputs          JSONB          NOT NULL                                 │  │  │
│   │  │       outputs         JSONB                                                   │  │  │
│   │  │       matched_rules   TEXT[]                   -- Array of rule IDs           │  │  │
│   │  │       duration_ns     BIGINT                                                  │  │  │
│   │  │       evaluated_at    TIMESTAMPTZ    NOT NULL  DEFAULT NOW()                  │  │  │
│   │  │       tenant_id       VARCHAR(64)                                             │  │  │
│   │  │       correlation_id  VARCHAR(255)             -- For distributed tracing     │  │  │
│   │  │       user_id         VARCHAR(255)                                            │  │  │
│   │  │       source_ip       INET                                                    │  │  │
│   │  │       error_message   TEXT                     -- If evaluation failed        │  │  │
│   │  │       status          VARCHAR(20)    NOT NULL  DEFAULT 'SUCCESS'              │  │  │
│   │  ├───────────────────────────────────────────────────────────────────────────────┤  │  │
│   │  │  «IX» idx_hist_def_key ON (definition_key)                                    │  │  │
│   │  │  «IX» idx_hist_tenant ON (tenant_id) WHERE tenant_id IS NOT NULL              │  │  │
│   │  │  «IX» idx_hist_evaluated ON (evaluated_at DESC)                               │  │  │
│   │  │  «IX» idx_hist_correlation ON (correlation_id) WHERE correlation_id NOT NULL  │  │  │
│   │  │  «IX» idx_hist_status ON (status)                                             │  │  │
│   │  └───────────────────────────────────────────────────────────────────────────────┘  │  │
│   │                                                                                     │  │
│   │  -- Partitioning by month for high-volume data                                     │  │
│   │  PARTITION BY RANGE (evaluated_at)                                                 │  │
│   └─────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐  │
│   │                              dmn_deployments                                        │  │
│   │  ┌───────────────────────────────────────────────────────────────────────────────┐  │  │
│   │  │  «PK» id              UUID           NOT NULL  DEFAULT gen_random_uuid()      │  │  │
│   │  │       name            VARCHAR(255)   NOT NULL                                 │  │  │
│   │  │       tenant_id       VARCHAR(64)                                             │  │  │
│   │  │       deployed_at     TIMESTAMPTZ    NOT NULL  DEFAULT NOW()                  │  │  │
│   │  │       deployed_by     VARCHAR(255)                                            │  │  │
│   │  │       source_type     VARCHAR(50)              -- 'FILE', 'API', 'GIT'        │  │  │
│   │  │       source_ref      VARCHAR(500)             -- File path or Git commit     │  │  │
│   │  └───────────────────────────────────────────────────────────────────────────────┘  │  │
│   └─────────────────────────────────────────────────────────────────────────────────────┘  │
│                                              │                                             │
│                                              │ 1                                           │
│                                              │                                             │
│                                              │ *                                           │
│                                              ▼                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐  │
│   │                          dmn_deployment_definitions                                 │  │
│   │  ┌───────────────────────────────────────────────────────────────────────────────┐  │  │
│   │  │  «PK» id              UUID           NOT NULL  DEFAULT gen_random_uuid()      │  │  │
│   │  │  «FK» deployment_id   UUID           NOT NULL  REFERENCES dmn_deployments(id) │  │  │
│   │  │  «FK» definition_id   UUID           NOT NULL  REFERENCES dmn_definitions(id) │  │  │
│   │  └───────────────────────────────────────────────────────────────────────────────┘  │  │
│   └─────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                dmn_tenants                                          │  │
│   │  ┌───────────────────────────────────────────────────────────────────────────────┐  │  │
│   │  │  «PK» id              VARCHAR(64)    NOT NULL                                 │  │  │
│   │  │       name            VARCHAR(255)   NOT NULL                                 │  │  │
│   │  │       settings        JSONB                    -- Tenant-specific config      │  │  │
│   │  │       rate_limit      INT                      -- Requests per second         │  │  │
│   │  │       is_active       BOOLEAN        NOT NULL  DEFAULT TRUE                   │  │  │
│   │  │       created_at      TIMESTAMPTZ    NOT NULL  DEFAULT NOW()                  │  │  │
│   │  └───────────────────────────────────────────────────────────────────────────────┘  │  │
│   └─────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 Database Schema (SQL)

```sql
-- Детальная схема в файле: deployments/docker/init.sql
```

### 4.3 Relationships Summary

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          RELATIONSHIPS                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  dmn_definitions ──────────< dmn_evaluation_history                         │
│       (1)           has many        (*)                                     │
│                                                                             │
│  dmn_deployments ──────────< dmn_deployment_definitions >──── dmn_definitions│
│       (1)           has many        (*)         belongs to      (1)         │
│                                                                             │
│  dmn_tenants ─────────────< dmn_definitions                                 │
│       (1)           has many        (*)                                     │
│                                                                             │
│  dmn_tenants ─────────────< dmn_evaluation_history                          │
│       (1)           has many        (*)                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. Диаграмма развёртывания

### 5.1 Deployment Diagram (Production)

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    DEPLOYMENT DIAGRAM                                               │
│                                    (Production Environment)                                         │
├─────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                     │
│                              ┌───────────────────────────────────────┐                              │
│                              │           «cloud»                     │                              │
│                              │         Internet                      │                              │
│                              └───────────────────┬───────────────────┘                              │
│                                                  │                                                  │
│                                                  │ HTTPS                                            │
│                                                  ▼                                                  │
│  ┌───────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                                «execution environment»                                        │  │
│  │                            Kubernetes Cluster (AWS EKS / GKE)                                 │  │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                               «namespace» dmn-engine                                    │  │  │
│  │  │                                                                                         │  │  │
│  │  │  ┌─────────────────────────────────────────────────────────────────────────────────┐   │  │  │
│  │  │  │                              «ingress»                                          │   │  │  │
│  │  │  │                        Ingress Controller (Nginx)                               │   │  │  │
│  │  │  │  ┌───────────────────────────────────────────────────────────────────────────┐  │   │  │  │
│  │  │  │  │  TLS Termination: *.dmn-engine.example.com                                │  │   │  │  │
│  │  │  │  │  Rate Limiting: 10000 req/s                                               │  │   │  │  │
│  │  │  │  │  Path: /api/* → dmn-engine-service:8080                                   │  │   │  │  │
│  │  │  │  └───────────────────────────────────────────────────────────────────────────┘  │   │  │  │
│  │  │  └─────────────────────────────────────────────────────────────────────────────────┘   │  │  │
│  │  │                                         │                                              │  │  │
│  │  │                                         │                                              │  │  │
│  │  │                                         ▼                                              │  │  │
│  │  │  ┌─────────────────────────────────────────────────────────────────────────────────┐   │  │  │
│  │  │  │                           «service»                                             │   │  │  │
│  │  │  │                    dmn-engine-service (ClusterIP)                               │   │  │  │
│  │  │  │                         Port: 8080                                              │   │  │  │
│  │  │  └─────────────────────────────────────────────────────────────────────────────────┘   │  │  │
│  │  │                                         │                                              │  │  │
│  │  │                          ┌──────────────┼──────────────┐                               │  │  │
│  │  │                          ▼              ▼              ▼                               │  │  │
│  │  │  ┌─────────────────────────────────────────────────────────────────────────────────┐   │  │  │
│  │  │  │                           «deployment»                                          │   │  │  │
│  │  │  │                    dmn-engine (replicas: 3-10, HPA)                             │   │  │  │
│  │  │  │  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐                           │   │  │  │
│  │  │  │  │   «pod»     │   │   «pod»     │   │   «pod»     │   ...                     │   │  │  │
│  │  │  │  │ ┌─────────┐ │   │ ┌─────────┐ │   │ ┌─────────┐ │                           │   │  │  │
│  │  │  │  │ │Container│ │   │ │Container│ │   │ │Container│ │                           │   │  │  │
│  │  │  │  │ │dmn-engine│ │   │ │dmn-engine│ │   │ │dmn-engine│ │                           │   │  │  │
│  │  │  │  │ │         │ │   │ │         │ │   │ │         │ │                           │   │  │  │
│  │  │  │  │ │Port:8080│ │   │ │Port:8080│ │   │ │Port:8080│ │                           │   │  │  │
│  │  │  │  │ │         │ │   │ │         │ │   │ │         │ │                           │   │  │  │
│  │  │  │  │ │CPU: 500m│ │   │ │CPU: 500m│ │   │ │CPU: 500m│ │                           │   │  │  │
│  │  │  │  │ │RAM: 512M│ │   │ │RAM: 512M│ │   │ │RAM: 512M│ │                           │   │  │  │
│  │  │  │  │ └─────────┘ │   │ └─────────┘ │   │ └─────────┘ │                           │   │  │  │
│  │  │  │  └─────────────┘   └─────────────┘   └─────────────┘                           │   │  │  │
│  │  │  │                                                                                 │   │  │  │
│  │  │  │  Resources:                                                                     │   │  │  │
│  │  │  │    CPU: 500m-1000m per pod                                                      │   │  │  │
│  │  │  │    Memory: 512Mi-1Gi per pod                                                    │   │  │  │
│  │  │  │  HPA:                                                                           │   │  │  │
│  │  │  │    Min: 3, Max: 10                                                              │   │  │  │
│  │  │  │    Target CPU: 70%                                                              │   │  │  │
│  │  │  └─────────────────────────────────────────────────────────────────────────────────┘   │  │  │
│  │  │                          │              │              │                               │  │  │
│  │  │                          │              │              │                               │  │  │
│  │  │  ┌───────────────────────┼──────────────┼──────────────┼───────────────────────────┐   │  │  │
│  │  │  │                       ▼              ▼              ▼                           │   │  │  │
│  │  │  │  ┌─────────────────────────────────────────────────────────────────────────┐   │   │  │  │
│  │  │  │  │                           «deployment»                                  │   │   │  │  │
│  │  │  │  │                    feel-engine (replicas: 2-5, HPA)                     │   │   │  │  │
│  │  │  │  │  ┌─────────────┐   ┌─────────────┐                                      │   │   │  │  │
│  │  │  │  │  │   «pod»     │   │   «pod»     │                                      │   │   │  │  │
│  │  │  │  │  │ ┌─────────┐ │   │ ┌─────────┐ │                                      │   │   │  │  │
│  │  │  │  │  │ │Container│ │   │ │Container│ │                                      │   │   │  │  │
│  │  │  │  │  │ │feel-scala│ │   │ │feel-scala│ │                                      │   │   │  │  │
│  │  │  │  │  │ │Port:8090│ │   │ │Port:8090│ │                                      │   │   │  │  │
│  │  │  │  │  │ │RAM: 1Gi │ │   │ │RAM: 1Gi │ │                                      │   │   │  │  │
│  │  │  │  │  │ └─────────┘ │   │ └─────────┘ │                                      │   │   │  │  │
│  │  │  │  │  └─────────────┘   └─────────────┘                                      │   │   │  │  │
│  │  │  │  └─────────────────────────────────────────────────────────────────────────┘   │   │  │  │
│  │  │  │                                         «sidecar deployment»                   │   │  │  │
│  │  │  └────────────────────────────────────────────────────────────────────────────────┘   │  │  │
│  │  │                                                                                        │  │  │
│  │  └────────────────────────────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                                              │  │
│  │  ┌────────────────────────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                               «namespace» data                                         │  │  │
│  │  │                                                                                        │  │  │
│  │  │   ┌──────────────────────────────────┐    ┌──────────────────────────────────┐        │  │  │
│  │  │   │       «statefulset»              │    │       «statefulset»              │        │  │  │
│  │  │   │      PostgreSQL HA               │    │       Redis Cluster              │        │  │  │
│  │  │   │                                  │    │                                  │        │  │  │
│  │  │   │  ┌────────┐ ┌────────┐          │    │  ┌────────┐ ┌────────┐          │        │  │  │
│  │  │   │  │Primary │ │Replica │          │    │  │Master  │ │Replica │          │        │  │  │
│  │  │   │  │        │ │        │          │    │  │        │ │        │          │        │  │  │
│  │  │   │  │:5432   │ │:5432   │          │    │  │:6379   │ │:6379   │          │        │  │  │
│  │  │   │  └────────┘ └────────┘          │    │  └────────┘ └────────┘          │        │  │  │
│  │  │   │                                  │    │                                  │        │  │  │
│  │  │   │  PVC: 100Gi SSD                  │    │  PVC: 10Gi SSD                   │        │  │  │
│  │  │   └──────────────────────────────────┘    └──────────────────────────────────┘        │  │  │
│  │  │                                                                                        │  │  │
│  │  └────────────────────────────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                                              │  │
│  │  ┌────────────────────────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                             «namespace» monitoring                                     │  │  │
│  │  │                                                                                        │  │  │
│  │  │   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │  │  │
│  │  │   │ Prometheus   │  │  Grafana     │  │   Jaeger     │  │  AlertMgr    │              │  │  │
│  │  │   │              │  │              │  │              │  │              │              │  │  │
│  │  │   │ Metrics      │  │ Dashboards   │  │ Traces       │  │ Alerts       │              │  │  │
│  │  │   └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘              │  │  │
│  │  │                                                                                        │  │  │
│  │  └────────────────────────────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                                              │  │
│  └──────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 Node Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                   NODE DIAGRAM                                              │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐  │
│   │                            «device» Load Balancer                                   │  │
│   │                                 (AWS ALB / GCP LB)                                  │  │
│   │  ┌───────────────────────────────────────────────────────────────────────────────┐  │  │
│   │  │  DNS: api.dmn-engine.example.com                                              │  │  │
│   │  │  Protocol: HTTPS (TLS 1.3)                                                    │  │  │
│   │  │  Health Check: /health                                                        │  │  │
│   │  └───────────────────────────────────────────────────────────────────────────────┘  │  │
│   └─────────────────────────────────────────────────────────────────────────────────────┘  │
│                                              │                                             │
│               ┌──────────────────────────────┼──────────────────────────────┐              │
│               ▼                              ▼                              ▼              │
│   ┌───────────────────────┐    ┌───────────────────────┐    ┌───────────────────────┐     │
│   │    «node» Worker-1    │    │    «node» Worker-2    │    │    «node» Worker-3    │     │
│   │   (c5.xlarge / n1-4)  │    │   (c5.xlarge / n1-4)  │    │   (c5.xlarge / n1-4)  │     │
│   │  ┌─────────────────┐  │    │  ┌─────────────────┐  │    │  ┌─────────────────┐  │     │
│   │  │                 │  │    │  │                 │  │    │  │                 │  │     │
│   │  │  dmn-engine     │  │    │  │  dmn-engine     │  │    │  │  dmn-engine     │  │     │
│   │  │  Pod (x2)       │  │    │  │  Pod (x2)       │  │    │  │  Pod (x2)       │  │     │
│   │  │                 │  │    │  │                 │  │    │  │                 │  │     │
│   │  │  feel-engine    │  │    │  │  feel-engine    │  │    │  │  feel-engine    │  │     │
│   │  │  Pod (x1)       │  │    │  │  Pod (x1)       │  │    │  │  Pod (x1)       │  │     │
│   │  │                 │  │    │  │                 │  │    │  │                 │  │     │
│   │  └─────────────────┘  │    │  └─────────────────┘  │    │  └─────────────────┘  │     │
│   │                       │    │                       │    │                       │     │
│   │  CPU: 4 vCPU          │    │  CPU: 4 vCPU          │    │  CPU: 4 vCPU          │     │
│   │  RAM: 16 GB           │    │  RAM: 16 GB           │    │  RAM: 16 GB           │     │
│   │  SSD: 100 GB          │    │  SSD: 100 GB          │    │  SSD: 100 GB          │     │
│   └───────────────────────┘    └───────────────────────┘    └───────────────────────┘     │
│                                                                                             │
│               ┌────────────────────────────────────────────────────────┐                   │
│               ▼                                                        ▼                   │
│   ┌───────────────────────────────────┐            ┌───────────────────────────────────┐  │
│   │    «node» Database Primary        │            │    «node» Database Replica        │  │
│   │    (r5.2xlarge / n1-highmem-8)    │            │    (r5.2xlarge / n1-highmem-8)    │  │
│   │  ┌─────────────────────────────┐  │            │  ┌─────────────────────────────┐  │  │
│   │  │                             │  │            │  │                             │  │  │
│   │  │  PostgreSQL 16              │  │  ──────▶   │  │  PostgreSQL 16              │  │  │
│   │  │  Primary                    │  │  Streaming │  │  Replica (Hot Standby)      │  │  │
│   │  │  Port: 5432                 │  │  Repl      │  │  Port: 5432                 │  │  │
│   │  │                             │  │            │  │                             │  │  │
│   │  └─────────────────────────────┘  │            │  └─────────────────────────────┘  │  │
│   │                                   │            │                                   │  │
│   │  CPU: 8 vCPU                      │            │  CPU: 8 vCPU                      │  │
│   │  RAM: 64 GB                       │            │  RAM: 64 GB                       │  │
│   │  SSD: 500 GB (io1/pd-ssd)         │            │  SSD: 500 GB (io1/pd-ssd)         │  │
│   │  IOPS: 10000                      │            │  IOPS: 10000                      │  │
│   └───────────────────────────────────┘            └───────────────────────────────────┘  │
│                                                                                             │
│   ┌───────────────────────────────────────────────────────────────────────────────────┐    │
│   │    «node» Redis Cluster                                                           │    │
│   │    (r5.large x 6 / n1-highmem-2 x 6)                                              │    │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                               │    │
│   │  │ Master 1    │  │ Master 2    │  │ Master 3    │                               │    │
│   │  │ :6379       │  │ :6379       │  │ :6379       │                               │    │
│   │  │ Slots: 0-   │  │ Slots:      │  │ Slots:      │                               │    │
│   │  │   5461      │  │  5462-10922 │  │  10923-16383│                               │    │
│   │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                               │    │
│   │         │                │                │                                       │    │
│   │         ▼                ▼                ▼                                       │    │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                               │    │
│   │  │ Replica 1   │  │ Replica 2   │  │ Replica 3   │                               │    │
│   │  │ :6379       │  │ :6379       │  │ :6379       │                               │    │
│   │  └─────────────┘  └─────────────┘  └─────────────┘                               │    │
│   │                                                                                   │    │
│   │  Total RAM: 12 GB (2GB x 6)                                                       │    │
│   └───────────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Диаграмма последовательности

### 6.1 Evaluate Decision Sequence

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                               SEQUENCE DIAGRAM: Evaluate Decision                                   │
├─────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                     │
│    Client          API Gateway       DMN Engine        Cache         DB           FEEL Engine       │
│       │                │                 │               │            │                │            │
│       │  POST /evaluate                  │               │            │                │            │
│       │───────────────▶│                 │               │            │                │            │
│       │                │                 │               │            │                │            │
│       │                │  forward        │               │            │                │            │
│       │                │────────────────▶│               │            │                │            │
│       │                │                 │               │            │                │            │
│       │                │                 │  get cached   │            │                │            │
│       │                │                 │  definition   │            │                │            │
│       │                │                 │──────────────▶│            │                │            │
│       │                │                 │               │            │                │            │
│       │                │                 │◀──────────────│            │                │            │
│       │                │                 │  cache miss   │            │                │            │
│       │                │                 │               │            │                │            │
│       │                │                 │  get from DB               │                │            │
│       │                │                 │──────────────────────────▶│                │            │
│       │                │                 │               │            │                │            │
│       │                │                 │◀──────────────────────────│                │            │
│       │                │                 │  definition   │            │                │            │
│       │                │                 │               │            │                │            │
│       │                │                 │  cache        │            │                │            │
│       │                │                 │  definition   │            │                │            │
│       │                │                 │──────────────▶│            │                │            │
│       │                │                 │               │            │                │            │
│       │                │                 │                                             │            │
│       │                │                 │──────────────────────────────loop──────────▶│            │
│       │                │                 │  evaluate input expression                  │            │
│       │                │                 │  [for each rule]                            │            │
│       │                │                 │◀────────────────────────────────────────────│            │
│       │                │                 │  value                                      │            │
│       │                │                 │                                             │            │
│       │                │                 │  evaluate unary test                        │            │
│       │                │                 │────────────────────────────────────────────▶│            │
│       │                │                 │◀────────────────────────────────────────────│            │
│       │                │                 │  match: true/false                          │            │
│       │                │                 │                                             │            │
│       │                │                 │  [if matched] evaluate output               │            │
│       │                │                 │────────────────────────────────────────────▶│            │
│       │                │                 │◀────────────────────────────────────────────│            │
│       │                │                 │──────────────────────────────end loop───────│            │
│       │                │                 │                                             │            │
│       │                │                 │  apply hit policy                           │            │
│       │                │                 │  ─────────────                              │            │
│       │                │                 │                                             │            │
│       │                │◀────────────────│                                             │            │
│       │                │  result         │                                             │            │
│       │                │                 │                                             │            │
│       │◀───────────────│                 │                                             │            │
│       │  200 OK        │                 │                                             │            │
│       │  {outputs}     │                 │                                             │            │
│       │                │                 │               │            │                │            │
│                                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 Deploy Definition Sequence

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                               SEQUENCE DIAGRAM: Deploy Definition                                   │
├─────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                     │
│    Client          API Handler       Parser        Validator        Repository       Cache          │
│       │                │                │               │                │             │            │
│       │  POST /deploy  │                │               │                │             │            │
│       │  {DMN XML}     │                │               │                │             │            │
│       │───────────────▶│                │               │                │             │            │
│       │                │                │               │                │             │            │
│       │                │  parse XML     │               │                │             │            │
│       │                │───────────────▶│               │                │             │            │
│       │                │                │               │                │             │            │
│       │                │◀───────────────│               │                │             │            │
│       │                │  *Definitions  │               │                │             │            │
│       │                │                │               │                │             │            │
│       │                │  validate      │               │                │             │            │
│       │                │───────────────────────────────▶│                │             │            │
│       │                │                │               │                │             │            │
│       │                │◀───────────────────────────────│                │             │            │
│       │                │  []errors (empty = valid)     │                │             │            │
│       │                │                │               │                │             │            │
│       │                │                │               │                │             │            │
│       │                │  alt [validation failed]       │                │             │            │
│       │◀───────────────│  ─────────────────────────────────────────────────────────────────────    │
│       │  400 Bad Request                │               │                │             │            │
│       │  {errors}      │                │               │                │             │            │
│       │                │                │               │                │             │            │
│       │                │                │               │                │             │            │
│       │                │  [validation passed]           │                │             │            │
│       │                │  ──────────────────────────────────────────────────────────────────────   │
│       │                │                │               │                │             │            │
│       │                │  get next version              │                │             │            │
│       │                │────────────────────────────────────────────────▶│             │            │
│       │                │                │               │                │             │            │
│       │                │◀────────────────────────────────────────────────│             │            │
│       │                │  version: N+1  │               │                │             │            │
│       │                │                │               │                │             │            │
│       │                │  save definition               │                │             │            │
│       │                │────────────────────────────────────────────────▶│             │            │
│       │                │                │               │                │             │            │
│       │                │◀────────────────────────────────────────────────│             │            │
│       │                │  *Definition   │               │                │             │            │
│       │                │                │               │                │             │            │
│       │                │  cache definition              │                │             │            │
│       │                │───────────────────────────────────────────────────────────────▶│            │
│       │                │                │               │                │             │            │
│       │◀───────────────│                │               │                │             │            │
│       │  201 Created   │                │               │                │             │            │
│       │  {definition}  │                │               │                │             │            │
│       │                │                │               │                │             │            │
│                                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. C4 Model

### 7.1 Level 1: System Context

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                              C4 MODEL - LEVEL 1: SYSTEM CONTEXT                             │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│                                                                                             │
│        ┌─────────────────┐                              ┌─────────────────┐                │
│        │    «person»     │                              │    «person»     │                │
│        │                 │                              │                 │                │
│        │    Business     │                              │    Developer    │                │
│        │    Analyst      │                              │                 │                │
│        │                 │                              │                 │                │
│        └────────┬────────┘                              └────────┬────────┘                │
│                 │                                                │                         │
│                 │ Deploys DMN                                    │ Integrates              │
│                 │ Models                                         │ API                     │
│                 │                                                │                         │
│                 ▼                                                ▼                         │
│        ┌─────────────────────────────────────────────────────────────────────┐            │
│        │                                                                     │            │
│        │                         «software system»                           │            │
│        │                                                                     │            │
│        │                         DMN ENGINE GO                               │            │
│        │                                                                     │            │
│        │   High-performance decision engine implementing DMN 1.3 standard   │            │
│        │                                                                     │            │
│        └─────────────────────────────────────────────────────────────────────┘            │
│                 │                          │                          │                   │
│                 │                          │                          │                   │
│                 ▼                          ▼                          ▼                   │
│   ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐          │
│   │  «software system»  │    │  «software system»  │    │  «software system»  │          │
│   │                     │    │                     │    │                     │          │
│   │   Backend Services  │    │   FEEL Engine       │    │   Monitoring        │          │
│   │                     │    │   (External)        │    │   (Prometheus)      │          │
│   │   Consumes decision │    │                     │    │                     │          │
│   │   evaluation API    │    │   Evaluates FEEL    │    │   Collects metrics  │          │
│   │                     │    │   expressions       │    │   and traces        │          │
│   └─────────────────────┘    └─────────────────────┘    └─────────────────────┘          │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 Level 2: Container

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                              C4 MODEL - LEVEL 2: CONTAINER                                  │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│   ┌───────────────────────────────────────────────────────────────────────────────────┐    │
│   │                              DMN ENGINE GO                                        │    │
│   │                                                                                   │    │
│   │   ┌─────────────────────────────────────────────────────────────────────────┐    │    │
│   │   │                        «container»                                      │    │    │
│   │   │                       API Application                                   │    │    │
│   │   │                          (Go)                                           │    │    │
│   │   │  ┌───────────────────────────────────────────────────────────────────┐  │    │    │
│   │   │  │  Provides REST API for:                                           │  │    │    │
│   │   │  │  • Deploying DMN definitions                                      │  │    │    │
│   │   │  │  • Evaluating decisions                                           │  │    │    │
│   │   │  │  • Managing decision history                                      │  │    │    │
│   │   │  │                                                                   │  │    │    │
│   │   │  │  Technology: Go 1.22, Fiber HTTP Framework                        │  │    │    │
│   │   │  └───────────────────────────────────────────────────────────────────┘  │    │    │
│   │   └─────────────────────────────────────────────────────────────────────────┘    │    │
│   │                   │              │                    │                          │    │
│   │                   │ reads/writes │ reads/writes       │ HTTP                     │    │
│   │                   ▼              ▼                    ▼                          │    │
│   │   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐     │    │
│   │   │   «container»   │  │   «container»   │  │       «container»           │     │    │
│   │   │   PostgreSQL    │  │   Redis Cache   │  │      FEEL Engine            │     │    │
│   │   │   Database      │  │                 │  │      (External)             │     │    │
│   │   │                 │  │                 │  │                             │     │    │
│   │   │  Stores:        │  │  Caches:        │  │  Evaluates:                 │     │    │
│   │   │  • Definitions  │  │  • Definitions  │  │  • FEEL expressions         │     │    │
│   │   │  • Deployments  │  │  • Eval results │  │  • Unary tests              │     │    │
│   │   │  • History      │  │  • Sessions     │  │                             │     │    │
│   │   │                 │  │                 │  │  Technology:                │     │    │
│   │   │  Technology:    │  │  Technology:    │  │  Scala/JVM or Rust          │     │    │
│   │   │  PostgreSQL 16  │  │  Redis 7       │  │                             │     │    │
│   │   └─────────────────┘  └─────────────────┘  └─────────────────────────────┘     │    │
│   │                                                                                   │    │
│   └───────────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 7.3 Level 3: Component

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                              C4 MODEL - LEVEL 3: COMPONENT                                  │
│                              (API Application Container)                                    │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│   ┌───────────────────────────────────────────────────────────────────────────────────┐    │
│   │                                                                                   │    │
│   │   ┌─────────────────────────────────────────────────────────────────────────┐    │    │
│   │   │                        «component»                                      │    │    │
│   │   │                     REST API Controller                                 │    │    │
│   │   │  ┌───────────────────────────────────────────────────────────────────┐  │    │    │
│   │   │  │  Handles HTTP requests, validates input, returns responses        │  │    │    │
│   │   │  │  Technology: Fiber v2                                             │  │    │    │
│   │   │  └───────────────────────────────────────────────────────────────────┘  │    │    │
│   │   └───────────────────────────────┬─────────────────────────────────────────┘    │    │
│   │                                   │                                              │    │
│   │               ┌───────────────────┼───────────────────┐                         │    │
│   │               ▼                   ▼                   ▼                         │    │
│   │   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                │    │
│   │   │   «component»   │  │   «component»   │  │   «component»   │                │    │
│   │   │   Definition    │  │   Evaluation    │  │    History      │                │    │
│   │   │   Service       │  │   Engine        │  │    Service      │                │    │
│   │   │                 │  │                 │  │                 │                │    │
│   │   │  Manages DMN    │  │  Executes DMN   │  │  Records and    │                │    │
│   │   │  lifecycle      │  │  decisions      │  │  queries audit  │                │    │
│   │   │                 │  │                 │  │                 │                │    │
│   │   └────────┬────────┘  └────────┬────────┘  └────────┬────────┘                │    │
│   │            │                    │                    │                         │    │
│   │            │           ┌────────┴────────┐           │                         │    │
│   │            │           ▼                 ▼           │                         │    │
│   │            │  ┌─────────────────┐ ┌─────────────────┐│                         │    │
│   │            │  │   «component»   │ │   «component»   ││                         │    │
│   │            │  │   DMN Parser    │ │   Hit Policy    ││                         │    │
│   │            │  │                 │ │   Engine        ││                         │    │
│   │            │  │  Parses DMN XML │ │                 ││                         │    │
│   │            │  │  to Go structs  │ │  Applies hit    ││                         │    │
│   │            │  │                 │ │  policies       ││                         │    │
│   │            │  └─────────────────┘ └─────────────────┘│                         │    │
│   │            │                                         │                         │    │
│   │            ▼                                         ▼                         │    │
│   │   ┌─────────────────┐                      ┌─────────────────┐                │    │
│   │   │   «component»   │                      │   «component»   │                │    │
│   │   │   Repository    │                      │   FEEL Client   │                │    │
│   │   │                 │                      │                 │                │    │
│   │   │  Abstracts DB   │                      │  Communicates   │                │    │
│   │   │  operations     │                      │  with FEEL svc  │                │    │
│   │   │                 │                      │                 │                │    │
│   │   └────────┬────────┘                      └────────┬────────┘                │    │
│   │            │                                        │                         │    │
│   └────────────┼────────────────────────────────────────┼─────────────────────────┘    │
│                │                                        │                              │
│                ▼                                        ▼                              │
│   ┌─────────────────────┐                    ┌─────────────────────┐                   │
│   │    PostgreSQL       │                    │    FEEL Engine      │                   │
│   │                     │                    │    (External)       │                   │
│   └─────────────────────┘                    └─────────────────────┘                   │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Приложения

### A. Технологический стек

| Слой | Технология | Версия | Назначение |
|------|------------|--------|------------|
| Language | Go | 1.22+ | Основной язык |
| HTTP | Fiber | 2.52+ | Web framework |
| Database | PostgreSQL | 16+ | Основное хранилище |
| Cache | Redis | 7+ | Кэширование |
| Metrics | Prometheus | - | Метрики |
| Tracing | OpenTelemetry | 1.22+ | Трейсинг |
| Container | Docker | 24+ | Контейнеризация |
| Orchestration | Kubernetes | 1.28+ | Оркестрация |

### B. Нефункциональные требования

| Метрика | Требование |
|---------|------------|
| Latency (P99) | < 50ms |
| Throughput | > 10,000 RPS |
| Availability | 99.9% |
| Cold Start | < 100ms |
| Memory per instance | < 512MB |

---

*Документ создан: 2024*
*Версия: 1.0*

